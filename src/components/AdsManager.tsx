'use client';

import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { useMetaAds } from '@/hooks/useMetaAds';
import { MetaCampaign, MetaAdSet, MetaAd, CampaignObjective, CampaignStatus, EffectiveStatus, InsightsDatePreset } from '@/lib/meta-types';

type AdsView = 'setup' | 'campaigns' | 'analytics';

function fmtMoney(cents: number): string { return `$${(cents / 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
function fmtMoneyDollars(dollars: number): string { return `$${dollars.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
function fmtNum(n: number): string { return n.toLocaleString('en-US'); }
function fmtPct(n: number): string { return `${n.toFixed(2)}%`; }
function fmtDate(iso: string): string { return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
function fmtBudget(campaign: MetaCampaign): string {
  if (campaign.daily_budget) return `${fmtMoney(parseInt(campaign.daily_budget, 10))}/day`;
  if (campaign.lifetime_budget) return `${fmtMoney(parseInt(campaign.lifetime_budget, 10))} lifetime`;
  return '—';
}

interface StatusConfig { label: string; bg: string; text: string; border: string; dot: string; }
function getStatusConfig(status: EffectiveStatus | CampaignStatus): StatusConfig {
  const map: Record<string, StatusConfig> = {
    ACTIVE: { label: 'Active', bg: 'rgba(0,204,102,0.12)', text: '#00cc66', border: 'rgba(0,204,102,0.3)', dot: '#00cc66' },
    PAUSED: { label: 'Paused', bg: 'rgba(255,170,0,0.12)', text: '#ffaa00', border: 'rgba(255,170,0,0.3)', dot: '#ffaa00' },
    WITH_ISSUES: { label: 'Issues', bg: 'rgba(255,51,85,0.12)', text: '#ff3355', border: 'rgba(255,51,85,0.3)', dot: '#ff3355' },
    PENDING_REVIEW: { label: 'Pending Review', bg: 'rgba(0,102,255,0.12)', text: '#3399ff', border: 'rgba(0,102,255,0.3)', dot: '#3399ff' },
    DELETED: { label: 'Deleted', bg: 'rgba(90,90,112,0.12)', text: '#5a5a70', border: 'rgba(90,90,112,0.3)', dot: '#5a5a70' },
    ARCHIVED: { label: 'Archived', bg: 'rgba(90,90,112,0.12)', text: '#5a5a70', border: 'rgba(90,90,112,0.3)', dot: '#5a5a70' },
    IN_PROCESS: { label: 'In Process', bg: 'rgba(0,102,255,0.12)', text: '#3399ff', border: 'rgba(0,102,255,0.3)', dot: '#3399ff' },
    CAMPAIGN_PAUSED: { label: 'Campaign Paused', bg: 'rgba(255,170,0,0.12)', text: '#ffaa00', border: 'rgba(255,170,0,0.3)', dot: '#ffaa00' },
    ADSET_PAUSED: { label: 'AdSet Paused', bg: 'rgba(255,170,0,0.12)', text: '#ffaa00', border: 'rgba(255,170,0,0.3)', dot: '#ffaa00' },
    DISAPPROVED: { label: 'Disapproved', bg: 'rgba(255,51,85,0.12)', text: '#ff3355', border: 'rgba(255,51,85,0.3)', dot: '#ff3355' },
    PREAPPROVED: { label: 'Pre-approved', bg: 'rgba(0,204,102,0.12)', text: '#00cc66', border: 'rgba(0,204,102,0.3)', dot: '#00cc66' },
    PENDING_BILLING_INFO: { label: 'Billing Needed', bg: 'rgba(255,170,0,0.12)', text: '#ffaa00', border: 'rgba(255,170,0,0.3)', dot: '#ffaa00' },
  };
  return map[status] ?? { label: status, bg: 'rgba(90,90,112,0.12)', text: '#5a5a70', border: 'rgba(90,90,112,0.3)', dot: '#5a5a70' };
}

function objectiveLabel(obj: CampaignObjective): string {
  const map: Record<CampaignObjective, string> = { OUTCOME_SALES: 'Sales', OUTCOME_LEADS: 'Leads', OUTCOME_TRAFFIC: 'Traffic', OUTCOME_AWARENESS: 'Awareness', OUTCOME_ENGAGEMENT: 'Engagement', OUTCOME_APP_PROMOTION: 'App Promotion' };
  return map[obj] ?? obj;
}

function IconMeta() { return (<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7H7.9v-2.9h2.54V9.85c0-2.51 1.49-3.89 3.78-3.89 1.09 0 2.23.19 2.23.19v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.78l-.45 2.9h-2.33v7a10 10 0 008.44-9.9c0-5.53-4.5-10.02-10-10.02z" /></svg>); }
function IconCheck() { return (<svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M2 8l4.5 4.5L14 4" /></svg>); }
function IconX({ size = 12 }: { size?: number }) { return (<svg width={size} height={size} viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M3 3l10 10M13 3L3 13" /></svg>); }
function IconRefresh({ spinning }: { spinning?: boolean }) { return (<svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" style={spinning ? { animation: 'spin 1s linear infinite' } : undefined}><path d="M14 8a6 6 0 11-1.5-4M14 2v4h-4" strokeLinejoin="round" /></svg>); }
function IconPlay() { return (<svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M4 3l9 5-9 5V3z" /></svg>); }
function IconPause() { return (<svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><rect x="3" y="2" width="4" height="12" rx="1" /><rect x="9" y="2" width="4" height="12" rx="1" /></svg>); }
function IconTrash() { return (<svg width="11" height="11" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"><path d="M2 4h12M5 4V2h6v2M6 7v5M10 7v5M3 4l1 10h8l1-10" /></svg>); }
function IconChevron({ open, size = 12 }: { open: boolean; size?: number }) { return (<svg width={size} height={size} viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" style={{ transform: open ? 'rotate(180deg)' : 'rotate(0deg)', transition: '150ms ease' }}><path d="M4 6l4 4 4-4" strokeLinecap="round" strokeLinejoin="round" /></svg>); }
function IconChevronRight() { return (<svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8"><path d="M6 4l4 4-4 4" strokeLinecap="round" strokeLinejoin="round" /></svg>); }
function IconPlus() { return (<svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M8 2v12M2 8h12" /></svg>); }
function IconRocket() { return (<svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M8 1s3 1 4 5c0 0 1 3-1 5L9 9l-2 2C5 13 2 14 2 14s1-3 3-4l2-2-2-2z" /><circle cx="11" cy="5" r="1" fill="currentColor" stroke="none" /></svg>); }
function IconSortAsc() { return (<svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><path d="M8 3v10M4 7l4-4 4 4" /></svg>); }
function IconSortDesc() { return (<svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><path d="M8 3v10M4 9l4 4 4-4" /></svg>); }
function IconWarning() { return (<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"><path d="M8 2L1 14h14L8 2z" strokeLinejoin="round" /><path d="M8 6v4" /><circle cx="8" cy="12" r="0.5" fill="currentColor" /></svg>); }
function IconInfo() { return (<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"><circle cx="8" cy="8" r="6" /><path d="M8 7v5" /><circle cx="8" cy="5" r="0.5" fill="currentColor" /></svg>); }
function IconCalendar() { return (<svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"><rect x="1" y="3" width="14" height="12" rx="2" /><path d="M1 7h14M5 1v4M11 1v4" /></svg>); }
function IconBolt() { return (<svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 1L4 9h5l-2 6 7-9H9z" /></svg>); }
function Spinner({ size = 14 }: { size?: number }) { return (<svg className="animate-spin" width={size} height={size} viewBox="0 0 24 24" fill="none"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" /></svg>); }

function StatusPill({ status }: { status: EffectiveStatus | CampaignStatus }) {
  const cfg = getStatusConfig(status);
  return (<span className="inline-flex items-center gap-1 text-[10px] font-semibold px-2 py-0.5 rounded-full whitespace-nowrap" style={{ background: cfg.bg, color: cfg.text, border: `1px solid ${cfg.border}` }}><span className="w-1.5 h-1.5 rounded-full flex-shrink-0" style={{ background: cfg.dot }} />{cfg.label}</span>);
}

function FormField({ label, required, children, hint }: { label: string; required?: boolean; children: React.ReactNode; hint?: string; }) {
  return (<div className="flex flex-col gap-1.5"><label className="flex items-center gap-1 text-[10px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em]">{label}{required && <span style={{ color: 'var(--danger)' }}>*</span>}</label>{children}{hint && <p className="text-[10px] text-af-text-tertiary/60 leading-relaxed">{hint}</p>}</div>);
}

const inputCls = 'w-full bg-af-bg-tertiary border border-af-border-default rounded-md text-af-text-primary text-[12px] px-3 py-2 outline-none focus:border-af-accent transition-colors placeholder:text-af-text-tertiary/40';
const selectCls = 'w-full bg-af-bg-tertiary border border-af-border-default rounded-md text-af-text-primary text-[12px] px-3 py-2 outline-none focus:border-af-accent transition-colors cursor-pointer';

function MetricCard({ label, value, loading, highlight }: { label: string; value: string; loading?: boolean; highlight?: boolean; }) {
  return (<div className="flex flex-col gap-1.5 p-4 rounded-lg border transition-all" style={{ background: highlight ? 'rgba(0,102,255,0.06)' : 'var(--bg-secondary)', borderColor: highlight ? 'rgba(0,102,255,0.2)' : 'var(--border-subtle)' }}><span className="text-[10px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em]">{label}</span>{loading ? (<div className="h-5 w-20 rounded animate-pulse bg-af-bg-elevated" />) : (<span className="text-[20px] font-bold tabular-nums leading-none" style={{ color: highlight ? '#3399ff' : 'var(--text-primary)' }}>{value}</span>)}</div>);
}

function SetupStep({ number, title, children }: { number: number; title: string; children: React.ReactNode; }) {
  return (<div className="flex gap-4"><div className="flex-shrink-0 flex flex-col items-center"><div className="w-6 h-6 rounded-full flex items-center justify-center text-[11px] font-bold flex-shrink-0" style={{ background: 'rgba(0,102,255,0.15)', color: '#3399ff', border: '1px solid rgba(0,102,255,0.3)' }}>{number}</div><div className="w-px flex-1 mt-2 mb-0" style={{ background: 'var(--border-subtle)', minHeight: 16 }} /></div><div className="pb-5 flex-1 min-w-0"><p className="text-[12px] font-semibold text-af-text-primary mb-1.5">{title}</p><div className="text-[11px] text-af-text-secondary leading-relaxed">{children}</div></div></div>);
}

interface DailyBar { date: string; spend: number; ctr: number; }
function BarChart({ data, metric }: { data: DailyBar[]; metric: 'spend' | 'ctr' }) {
  const values = data.map((d) => (metric === 'spend' ? d.spend : d.ctr));
  const maxVal = Math.max(...values, 0.001);
  return (<div className="flex items-end gap-1 h-full w-full">{data.map((d, i) => { const val = metric === 'spend' ? d.spend : d.ctr; const heightPct = maxVal > 0 ? (val / maxVal) * 100 : 0; const label = metric === 'spend' ? fmtMoneyDollars(val) : fmtPct(val); const shortDate = new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); return (<div key={i} className="flex-1 flex flex-col items-center gap-1 group relative" style={{ minWidth: 0 }}><div className="absolute bottom-full mb-1.5 left-1/2 -translate-x-1/2 px-2 py-1 rounded text-[10px] font-medium whitespace-nowrap pointer-events-none z-10 opacity-0 group-hover:opacity-100 transition-opacity" style={{ background: 'var(--bg-elevated)', border: '1px solid var(--border-default)', color: 'var(--text-primary)' }}>{shortDate}: {label}</div><div className="w-full rounded-t transition-all duration-200 group-hover:opacity-80" style={{ height: `${Math.max(heightPct, 2)}%`, background: metric === 'spend' ? 'linear-gradient(180deg, #0066FF 0%, rgba(0,102,255,0.5) 100%)' : 'linear-gradient(180deg, #00cc66 0%, rgba(0,204,102,0.5) 100%)' }} />{(i === 0 || i === Math.floor(data.length / 2) || i === data.length - 1) && (<span className="text-[9px] text-af-text-tertiary/50 truncate w-full text-center">{shortDate}</span>)}</div>); })}</div>);
}

interface CampaignFormData { name: string; objective: CampaignObjective; budgetType: 'daily' | 'lifetime'; budgetAmount: string; status: CampaignStatus; specialAdCategories: string[]; }
const SPECIAL_AD_CATEGORIES = [{ value: 'CREDIT', label: 'Credit' }, { value: 'EMPLOYMENT', label: 'Employment' }, { value: 'HOUSING', label: 'Housing' }, { value: 'ISSUES_ELECTIONS_POLITICS', label: 'Social/Political' }];
const OBJECTIVES: { value: CampaignObjective; label: string; desc: string }[] = [
  { value: 'OUTCOME_SALES', label: 'Sales', desc: 'Drive purchases and conversions' },
  { value: 'OUTCOME_LEADS', label: 'Leads', desc: 'Collect leads for your business' },
  { value: 'OUTCOME_TRAFFIC', label: 'Traffic', desc: 'Send people to a destination' },
  { value: 'OUTCOME_AWARENESS', label: 'Awareness', desc: 'Reach people likely to remember your ad' },
  { value: 'OUTCOME_ENGAGEMENT', label: 'Engagement', desc: 'Get more messages, video views, or followers' },
  { value: 'OUTCOME_APP_PROMOTION', label: 'App Promotion', desc: 'Find new users or re-engage existing ones' },
];
const defaultCampaignForm: CampaignFormData = { name: '', objective: 'OUTCOME_SALES', budgetType: 'daily', budgetAmount: '', status: 'PAUSED', specialAdCategories: [] };

interface LaunchAdFormData { adSetId: string; adName: string; imageUrl: string; message: string; headline: string; linkUrl: string; pageId: string; }
const defaultLaunchAdForm: LaunchAdFormData = { adSetId: '', adName: '', imageUrl: '', message: '', headline: '', linkUrl: '', pageId: '' };

export default function AdsManager() {
  const meta = useMetaAds();
  const [view, setView] = useState<AdsView>('setup');
  const [expandedCampaigns, setExpandedCampaigns] = useState<Set<string>>(new Set());
  const [expandedAdSets, setExpandedAdSets] = useState<Set<string>>(new Set());
  const [showCampaignForm, setShowCampaignForm] = useState(false);
  const [campaignForm, setCampaignForm] = useState<CampaignFormData>(defaultCampaignForm);
  const [campaignFormSubmitting, setCampaignFormSubmitting] = useState(false);
  const [confirmDelete, setConfirmDelete] = useState<{ type: 'campaign' | 'ad'; id: string; name: string } | null>(null);
  const [showLaunchAd, setShowLaunchAd] = useState(false);
  const [launchAdForm, setLaunchAdForm] = useState<LaunchAdFormData>(defaultLaunchAdForm);
  const [launchAdSubmitting, setLaunchAdSubmitting] = useState(false);
  const [launchAdSuccess, setLaunchAdSuccess] = useState<string | null>(null);
  const [analyticsDatePreset, setAnalyticsDatePreset] = useState<InsightsDatePreset>('last_7d');
  const [sortColumn, setSortColumn] = useState<'spend' | 'impressions' | 'clicks' | 'ctr' | 'roas'>('spend');
  const [sortDir, setSortDir] = useState<'asc' | 'desc'>('desc');
  const [lastRefreshed, setLastRefreshed] = useState<Date | null>(null);
  const [chartMetric, setChartMetric] = useState<'spend' | 'ctr'>('spend');
  const [minutesSince, setMinutesSince] = useState(0);
  const tickRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    if (tickRef.current) clearInterval(tickRef.current);
    tickRef.current = setInterval(() => { if (lastRefreshed) setMinutesSince(Math.floor((Date.now() - lastRefreshed.getTime()) / 60000)); }, 30000);
    return () => { if (tickRef.current) clearInterval(tickRef.current); };
  }, [lastRefreshed]);

  const toggleCampaign = useCallback((id: string) => { setExpandedCampaigns((prev) => { const next = new Set(prev); if (next.has(id)) { next.delete(id); } else { next.add(id); meta.fetchAdSets(id); } return next; }); }, [meta]);
  const toggleAdSet = useCallback((id: string) => { setExpandedAdSets((prev) => { const next = new Set(prev); if (next.has(id)) { next.delete(id); } else { next.add(id); meta.fetchAds(id); } return next; }); }, [meta]);

  const handleCampaignAction = useCallback(async (id: string, action: 'play' | 'pause' | 'delete') => {
    if (action === 'delete') { const campaign = meta.campaigns.find((c) => c.id === id); if (campaign) setConfirmDelete({ type: 'campaign', id, name: campaign.name }); return; }
    await meta.updateCampaignStatus(id, action === 'play' ? 'ACTIVE' : 'PAUSED');
  }, [meta]);

  const handleConfirmDelete = useCallback(async () => {
    if (!confirmDelete) return;
    if (confirmDelete.type === 'campaign') await meta.updateCampaignStatus(confirmDelete.id, 'DELETED');
    setConfirmDelete(null);
  }, [confirmDelete, meta]);

  const handleCreateCampaign = useCallback(async () => {
    if (!campaignForm.name.trim() || !campaignForm.budgetAmount) return;
    setCampaignFormSubmitting(true);
    const amountDollars = parseFloat(campaignForm.budgetAmount);
    if (isNaN(amountDollars) || amountDollars <= 0) { setCampaignFormSubmitting(false); return; }
    const amountCents = Math.round(amountDollars * 100);
    const payload = { name: campaignForm.name.trim(), objective: campaignForm.objective, status: campaignForm.status, special_ad_categories: campaignForm.specialAdCategories.length > 0 ? campaignForm.specialAdCategories : ['NONE'], ...(campaignForm.budgetType === 'daily' ? { daily_budget: amountCents } : { lifetime_budget: amountCents }) };
    const id = await meta.createCampaign(payload);
    setCampaignFormSubmitting(false);
    if (id) { setShowCampaignForm(false); setCampaignForm(defaultCampaignForm); }
  }, [campaignForm, meta]);

  const handleLaunchAd = useCallback(async () => {
    if (!launchAdForm.adSetId || !launchAdForm.imageUrl || !launchAdForm.pageId) return;
    setLaunchAdSubmitting(true); setLaunchAdSuccess(null);
    const result = await meta.createAdWithCreative({ name: launchAdForm.adName || 'AdForge Ad', adset_id: launchAdForm.adSetId, page_id: launchAdForm.pageId, image_url: launchAdForm.imageUrl, message: launchAdForm.message, headline: launchAdForm.headline, link_url: launchAdForm.linkUrl, status: 'ACTIVE' });
    setLaunchAdSubmitting(false);
    if (result) { setLaunchAdSuccess(result.adId); setLaunchAdForm(defaultLaunchAdForm); setTimeout(() => { setLaunchAdSuccess(null); setShowLaunchAd(false); }, 2500); }
  }, [launchAdForm, meta]);

  const handleSort = useCallback((col: typeof sortColumn) => { if (sortColumn === col) { setSortDir((d) => (d === 'desc' ? 'asc' : 'desc')); } else { setSortColumn(col); setSortDir('desc'); } }, [sortColumn]);
  const sortedBreakdown = useMemo(() => { if (!meta.metrics?.campaignBreakdown) return []; return [...meta.metrics.campaignBreakdown].sort((a, b) => sortDir === 'desc' ? b[sortColumn] - a[sortColumn] : a[sortColumn] - b[sortColumn]); }, [meta.metrics, sortColumn, sortDir]);
  const handleDatePresetChange = useCallback((preset: InsightsDatePreset) => { setAnalyticsDatePreset(preset); meta.setDatePreset(preset); meta.fetchMetrics(preset).then(() => setLastRefreshed(new Date())); }, [meta]);
  const handleRefreshAnalytics = useCallback(async () => { await meta.fetchMetrics(analyticsDatePreset); setLastRefreshed(new Date()); setMinutesSince(0); }, [analyticsDatePreset, meta]);

  const tabs: { id: AdsView; label: string }[] = [{ id: 'setup', label: 'Setup' }, { id: 'campaigns', label: 'Campaigns' }, { id: 'analytics', label: 'Analytics' }];

  return (
    <>
      <style>{`@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`}</style>
      <div className="flex-1 flex flex-col overflow-hidden" style={{ background: 'var(--bg-primary)' }}>
        <div className="flex-shrink-0 flex items-center gap-0.5 px-6 py-3 border-b" style={{ borderColor: 'var(--border-subtle)', background: 'var(--bg-secondary)' }}>
          <div className="flex items-center gap-1 mr-5">
            <span className="text-af-accent"><IconMeta /></span>
            <span className="text-[13px] font-semibold text-af-text-primary">Meta Ads Manager</span>
            {meta.connection?.connected && (<span className="ml-2 text-[10px] font-medium px-2 py-0.5 rounded-full" style={{ background: 'rgba(0,204,102,0.12)', color: '#00cc66', border: '1px solid rgba(0,204,102,0.3)' }}>Connected</span>)}
          </div>
          <div className="flex items-center gap-0.5">{tabs.map((tab) => (<button key={tab.id} onClick={() => setView(tab.id)} className="px-4 py-1.5 rounded text-[12px] font-medium transition-all" style={view === tab.id ? { background: 'rgba(0,102,255,0.12)', color: '#3399ff', border: '1px solid rgba(0,102,255,0.25)' } : { color: 'var(--text-secondary)', border: '1px solid transparent' }}>{tab.label}</button>))}</div>
          {meta.error && (<div className="ml-auto flex items-center gap-2 px-3 py-1 rounded text-[11px]" style={{ background: 'rgba(255,51,85,0.1)', color: '#ff5577', border: '1px solid rgba(255,51,85,0.2)' }}><IconWarning />{meta.error}<button onClick={() => meta.setError(null)} className="opacity-60 hover:opacity-100 transition-opacity ml-1"><IconX size={10} /></button></div>)}
        </div>

        <div className="flex-1 overflow-y-auto">
          {view === 'setup' && (
            <div className="max-w-2xl mx-auto px-6 py-8">
              <div className="mb-8"><div className="flex items-center gap-3 mb-3"><div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ background: 'rgba(0,102,255,0.12)', border: '1px solid rgba(0,102,255,0.2)' }}><span className="text-af-accent" style={{ transform: 'scale(1.4)' }}><IconMeta /></span></div><div><h2 className="text-[16px] font-bold text-af-text-primary">Connect Meta Ads</h2><p className="text-[11px] text-af-text-tertiary mt-0.5">Set up your Meta Developer App to manage campaigns from AdForge.</p></div></div></div>
              <div className="rounded-xl p-6 mb-6" style={{ background: 'var(--bg-secondary)', border: '1px solid var(--border-subtle)' }}>
                <p className="text-[11px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em] mb-5">Setup Instructions</p>
                <SetupStep number={1} title="Create a Meta Developer App">Go to <a href="https://developers.facebook.com" target="_blank" rel="noopener noreferrer" className="underline" style={{ color: '#3399ff' }}>developers.facebook.com</a> → <strong className="text-af-text-primary">My Apps</strong> → <strong className="text-af-text-primary">Create App</strong>. Select the <strong className="text-af-text-primary">Business</strong> app type.</SetupStep>
                <SetupStep number={2} title="Add the Marketing API Product">In your app dashboard, click <strong className="text-af-text-primary">Add Product</strong>, find <strong className="text-af-text-primary">Marketing API</strong>, and click Set Up.</SetupStep>
                <SetupStep number={3} title="Generate a System User Token">In <strong className="text-af-text-primary">Business Manager → System Users</strong>, create or select a System User. Click <strong className="text-af-text-primary">Generate New Token</strong> and grant these permissions:<div className="flex flex-wrap gap-1.5 mt-2">{['ads_management', 'ads_read', 'business_management', 'pages_read_engagement', 'pages_manage_ads'].map((p) => (<code key={p} className="text-[10px] px-2 py-0.5 rounded font-mono" style={{ background: 'var(--bg-elevated)', color: '#3399ff', border: '1px solid var(--border-default)' }}>{p}</code>))}</div></SetupStep>
                <SetupStep number={4} title="Get your Ad Account ID">In <strong className="text-af-text-primary">Business Manager → Ad Accounts</strong>, copy your account ID. It should be formatted as <code className="text-[10px] px-1.5 py-0.5 rounded font-mono" style={{ background: 'var(--bg-elevated)', color: '#ffaa00', border: '1px solid var(--border-default)' }}>act_XXXXXXXX</code>.</SetupStep>
                <SetupStep number={5} title="Enter your credentials below"><p className="text-[11px] mb-3" style={{ color: 'var(--text-tertiary)' }}>Paste your System User token and Ad Account ID into the fields below, then click Test Connection.</p></SetupStep>
              </div>
              <div className="rounded-xl p-5" style={{ background: 'var(--bg-secondary)', border: '1px solid var(--border-subtle)' }}>
                <p className="text-[12px] font-semibold text-af-text-primary mb-4">Your Meta Credentials</p>
                <div className="mb-3"><label className="block text-[10px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em] mb-1.5">System User Access Token</label><input type="password" value={meta.credentials.accessToken} onChange={(e) => meta.setCredentials((c) => ({ ...c, accessToken: e.target.value }))} placeholder="EAAxxxxxxx..." className="w-full px-3 py-2.5 rounded-lg text-[12px] font-mono outline-none transition-all" style={{ background: 'var(--bg-elevated)', border: '1px solid var(--border-default)', color: 'var(--text-primary)' }} onFocus={(e) => (e.target.style.borderColor = 'var(--accent)')} onBlur={(e) => (e.target.style.borderColor = 'var(--border-default)')} /></div>
                <div className="mb-5"><label className="block text-[10px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em] mb-1.5">Ad Account ID</label><input type="text" value={meta.credentials.adAccountId} onChange={(e) => meta.setCredentials((c) => ({ ...c, adAccountId: e.target.value }))} placeholder="act_XXXXXXXX or just the number" className="w-full px-3 py-2.5 rounded-lg text-[12px] font-mono outline-none transition-all" style={{ background: 'var(--bg-elevated)', border: '1px solid var(--border-default)', color: 'var(--text-primary)' }} onFocus={(e) => (e.target.style.borderColor = 'var(--accent)')} onBlur={(e) => (e.target.style.borderColor = 'var(--border-default)')} /><p className="mt-1.5 text-[10px]" style={{ color: 'var(--text-tertiary)' }}>The act_ prefix is optional — it will be added automatically.</p></div>
                <div className="flex items-start gap-2 px-3 py-2.5 rounded-lg mb-5" style={{ background: 'rgba(0,102,255,0.06)', border: '1px solid rgba(0,102,255,0.15)' }}><span className="flex-shrink-0 mt-0.5" style={{ color: '#3399ff' }}><IconInfo /></span><p className="text-[10.5px] leading-relaxed" style={{ color: 'var(--text-secondary)' }}>Your credentials are only stored in your browser session and sent securely with each request. They are never saved to any database or logged.</p></div>
                {meta.connection?.connected && (<div className="flex items-start gap-3 p-4 rounded-lg mb-4" style={{ background: 'rgba(0,204,102,0.08)', border: '1px solid rgba(0,204,102,0.25)' }}><div className="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5" style={{ background: '#00cc66', color: '#fff' }}><IconCheck /></div><div><p className="text-[12px] font-semibold" style={{ color: '#00cc66' }}>Connected successfully</p><div className="mt-2 flex flex-wrap gap-4">{meta.connection.accountName && (<div><p className="text-[10px] text-af-text-tertiary uppercase tracking-[0.06em]">Account</p><p className="text-[12px] text-af-text-primary font-medium">{meta.connection.accountName}</p></div>)}{meta.connection.currency && (<div><p className="text-[10px] text-af-text-tertiary uppercase tracking-[0.06em]">Currency</p><p className="text-[12px] text-af-text-primary font-medium">{meta.connection.currency}</p></div>)}{meta.connection.timezone && (<div><p className="text-[10px] text-af-text-tertiary uppercase tracking-[0.06em]">Timezone</p><p className="text-[12px] text-af-text-primary font-medium">{meta.connection.timezone}</p></div>)}{meta.connection.accountId && (<div><p className="text-[10px] text-af-text-tertiary uppercase tracking-[0.06em]">Account ID</p><code className="text-[11px] font-mono" style={{ color: '#3399ff' }}>{meta.connection.accountId}</code></div>)}</div></div></div>)}
                {meta.connection && !meta.connection.connected && (<div className="flex items-start gap-3 p-4 rounded-lg mb-4" style={{ background: 'rgba(255,51,85,0.08)', border: '1px solid rgba(255,51,85,0.25)' }}><div className="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5" style={{ background: 'rgba(255,51,85,0.2)', color: '#ff3355' }}><IconX size={10} /></div><div><p className="text-[12px] font-semibold" style={{ color: '#ff5577' }}>Connection failed</p>{meta.connection.error && (<p className="text-[11px] mt-1" style={{ color: '#ff5577', opacity: 0.8 }}>{meta.connection.error}</p>)}</div></div>)}
                <div className="flex items-center gap-3"><button onClick={() => { const creds = { accessToken: meta.credentials.accessToken, adAccountId: meta.credentials.adAccountId }; meta.testConnection(creds).then((r) => { if (r.connected) { setView('campaigns'); meta.fetchCampaigns(); meta.fetchMetrics('last_7d'); meta.startAutoRefresh(); setLastRefreshed(new Date()); } }); }} disabled={meta.connecting || !meta.credentials.accessToken || !meta.credentials.adAccountId} className="flex items-center gap-2 px-5 py-2.5 rounded-lg text-[12px] font-semibold transition-all disabled:opacity-50" style={{ background: 'var(--accent)', color: '#fff', border: '1px solid var(--accent)' }}>{meta.connecting ? <><Spinner size={13} /> Testing…</> : 'Test Connection'}</button>{meta.connection?.connected && (<button onClick={() => setView('campaigns')} className="flex items-center gap-1.5 text-[12px] font-medium transition-all" style={{ color: '#3399ff' }}>Go to Campaigns <IconChevronRight /></button>)}</div>
              </div>
            </div>
          )}

          {view === 'campaigns' && (
            <div className="flex flex-col h-full">
              <div className="flex-shrink-0 flex items-center justify-between gap-4 px-6 py-3.5 border-b" style={{ borderColor: 'var(--border-subtle)', background: 'var(--bg-secondary)' }}>
                <div className="flex items-center gap-2"><span className="text-[13px] font-semibold text-af-text-primary">Campaigns</span>{meta.campaigns.length > 0 && (<span className="text-[10px] font-medium px-1.5 py-0.5 rounded-full" style={{ background: 'var(--bg-elevated)', color: 'var(--text-tertiary)', border: '1px solid var(--border-default)' }}>{meta.campaigns.length}</span>)}</div>
                <div className="flex items-center gap-2"><button onClick={() => meta.fetchCampaigns()} disabled={meta.loadingCampaigns} className="flex items-center gap-1.5 px-3 py-1.5 rounded text-[11px] font-medium transition-all" style={{ background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', border: '1px solid var(--border-default)' }}><IconRefresh spinning={meta.loadingCampaigns} />Refresh</button><button onClick={() => { setShowLaunchAd(true); setShowCampaignForm(false); }} className="flex items-center gap-1.5 px-3 py-1.5 rounded text-[11px] font-medium transition-all" style={{ background: 'var(--bg-tertiary)', color: '#ffaa00', border: '1px solid rgba(255,170,0,0.2)' }}><IconBolt /> Quick Launch Ad</button><button onClick={() => { setShowCampaignForm(true); setShowLaunchAd(false); }} className="flex items-center gap-1.5 px-4 py-1.5 rounded text-[11px] font-semibold transition-all" style={{ background: 'var(--accent)', color: '#fff', border: '1px solid var(--accent)' }}><IconPlus /> New Campaign</button></div>
              </div>
              {showCampaignForm && (
                <div className="flex-shrink-0 mx-6 mt-4 mb-2 rounded-xl overflow-hidden" style={{ border: '1px solid var(--border-default)' }}>
                  <div className="flex items-center justify-between px-5 py-3.5" style={{ background: 'var(--bg-secondary)', borderBottom: '1px solid var(--border-subtle)' }}><span className="text-[12px] font-semibold text-af-text-primary">New Campaign</span><button onClick={() => { setShowCampaignForm(false); setCampaignForm(defaultCampaignForm); }} className="w-6 h-6 flex items-center justify-center rounded text-af-text-tertiary hover:text-af-text-primary transition-all"><IconX size={11} /></button></div>
                  <div className="p-5 grid grid-cols-2 gap-4" style={{ background: 'var(--bg-tertiary)' }}>
                    <div className="col-span-2"><FormField label="Campaign Name" required><input type="text" value={campaignForm.name} onChange={(e) => setCampaignForm((f) => ({ ...f, name: e.target.value }))} placeholder="e.g. Summer Sale 2026" className={inputCls} /></FormField></div>
                    <div className="col-span-2"><FormField label="Campaign Objective" required><div className="grid grid-cols-3 gap-2">{OBJECTIVES.map((obj) => (<button key={obj.value} onClick={() => setCampaignForm((f) => ({ ...f, objective: obj.value }))} className="flex flex-col gap-0.5 p-3 rounded-lg text-left transition-all" style={campaignForm.objective === obj.value ? { background: 'rgba(0,102,255,0.12)', border: '1px solid rgba(0,102,255,0.3)', color: '#3399ff' } : { background: 'var(--bg-elevated)', border: '1px solid var(--border-default)', color: 'var(--text-secondary)' }}><span className="text-[11px] font-semibold">{obj.label}</span><span className="text-[10px] opacity-70 leading-snug">{obj.desc}</span></button>))}</div></FormField></div>
                    <div><FormField label="Budget Type" required><div className="flex rounded-lg overflow-hidden border" style={{ borderColor: 'var(--border-default)' }}>{(['daily', 'lifetime'] as const).map((t) => (<button key={t} onClick={() => setCampaignForm((f) => ({ ...f, budgetType: t }))} className="flex-1 py-2 text-[11px] font-semibold transition-all capitalize" style={campaignForm.budgetType === t ? { background: 'rgba(0,102,255,0.12)', color: '#3399ff' } : { background: 'var(--bg-elevated)', color: 'var(--text-secondary)' }}>{t}</button>))}</div></FormField></div>
                    <div><FormField label={`${campaignForm.budgetType === 'daily' ? 'Daily' : 'Lifetime'} Budget (USD)`} required><div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-[12px] font-semibold" style={{ color: 'var(--text-tertiary)' }}>$</span><input type="number" min="1" step="0.01" value={campaignForm.budgetAmount} onChange={(e) => setCampaignForm((f) => ({ ...f, budgetAmount: e.target.value }))} placeholder="50.00" className={`${inputCls} pl-7`} /></div></FormField></div>
                    <div><FormField label="Launch Status"><div className="flex rounded-lg overflow-hidden border" style={{ borderColor: 'var(--border-default)' }}>{([{ value: 'ACTIVE', label: 'Active', color: '#00cc66' }, { value: 'PAUSED', label: 'Paused', color: '#ffaa00' }] as const).map((opt) => (<button key={opt.value} onClick={() => setCampaignForm((f) => ({ ...f, status: opt.value }))} className="flex-1 py-2 text-[11px] font-semibold transition-all" style={campaignForm.status === opt.value ? { background: `${opt.color}18`, color: opt.color } : { background: 'var(--bg-elevated)', color: 'var(--text-secondary)' }}>{opt.label}</button>))}</div></FormField></div>
                    <div><FormField label="Special Ad Categories" hint="Required by Meta for certain industries"><div className="flex flex-wrap gap-1.5">{SPECIAL_AD_CATEGORIES.map((cat) => { const active = campaignForm.specialAdCategories.includes(cat.value); return (<button key={cat.value} onClick={() => setCampaignForm((f) => ({ ...f, specialAdCategories: active ? f.specialAdCategories.filter((c) => c !== cat.value) : [...f.specialAdCategories, cat.value] }))} className="flex items-center gap-1 px-2.5 py-1 rounded text-[10px] font-medium transition-all" style={active ? { background: 'rgba(255,170,0,0.12)', color: '#ffaa00', border: '1px solid rgba(255,170,0,0.3)' } : { background: 'var(--bg-elevated)', color: 'var(--text-tertiary)', border: '1px solid var(--border-default)' }}>{active && <IconCheck />}{cat.label}</button>); })}</div></FormField></div>
                    <div className="col-span-2 flex items-center justify-end gap-2 pt-2 border-t" style={{ borderColor: 'var(--border-subtle)' }}><button onClick={() => { setShowCampaignForm(false); setCampaignForm(defaultCampaignForm); }} className="px-4 py-2 rounded text-[11px] font-medium transition-all" style={{ background: 'var(--bg-elevated)', color: 'var(--text-secondary)', border: '1px solid var(--border-default)' }}>Cancel</button><button onClick={handleCreateCampaign} disabled={campaignFormSubmitting || !campaignForm.name.trim() || !campaignForm.budgetAmount} className="flex items-center gap-2 px-5 py-2 rounded text-[11px] font-semibold transition-all disabled:opacity-50" style={{ background: 'var(--accent)', color: '#fff', border: '1px solid var(--accent)' }}>{campaignFormSubmitting ? <><Spinner size={12} /> Creating…</> : <><IconRocket /> Create Campaign</>}</button></div>
                  </div>
                </div>
              )}
              {showLaunchAd && (
                <div className="flex-shrink-0 mx-6 mt-4 mb-2 rounded-xl overflow-hidden" style={{ border: '1px solid rgba(255,170,0,0.2)' }}>
                  <div className="flex items-center justify-between px-5 py-3.5" style={{ background: 'var(--bg-secondary)', borderBottom: '1px solid var(--border-subtle)' }}><div className="flex items-center gap-2"><span style={{ color: '#ffaa00' }}><IconBolt /></span><span className="text-[12px] font-semibold text-af-text-primary">Quick Launch Ad</span><span className="text-[10px] text-af-text-tertiary">Creative + Ad in one step</span></div><button onClick={() => { setShowLaunchAd(false); setLaunchAdForm(defaultLaunchAdForm); setLaunchAdSuccess(null); }} className="w-6 h-6 flex items-center justify-center rounded text-af-text-tertiary hover:text-af-text-primary transition-all"><IconX size={11} /></button></div>
                  {launchAdSuccess ? (<div className="flex items-center gap-3 p-5" style={{ background: 'rgba(0,204,102,0.06)' }}><div className="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style={{ background: '#00cc66', color: '#fff' }}><IconCheck /></div><div><p className="text-[13px] font-semibold" style={{ color: '#00cc66' }}>Ad launched!</p><p className="text-[11px] text-af-text-tertiary mt-0.5">Ad ID: <code style={{ color: '#3399ff' }}>{launchAdSuccess}</code></p></div></div>) : (
                    <div className="p-5 grid grid-cols-2 gap-4" style={{ background: 'var(--bg-tertiary)' }}>
                      <div><FormField label="Ad Set" required hint="Choose which ad set to place this ad in"><select value={launchAdForm.adSetId} onChange={(e) => setLaunchAdForm((f) => ({ ...f, adSetId: e.target.value }))} className={selectCls}><option value="">Select ad set…</option>{meta.adSets.map((as) => (<option key={as.id} value={as.id}>{as.name}</option>))}</select></FormField></div>
                      <div><FormField label="Ad Name"><input type="text" value={launchAdForm.adName} onChange={(e) => setLaunchAdForm((f) => ({ ...f, adName: e.target.value }))} placeholder="AdForge Creative" className={inputCls} /></FormField></div>
                      <div className="col-span-2"><FormField label="Image URL" required hint="AdForge creative image URL"><input type="url" value={launchAdForm.imageUrl} onChange={(e) => setLaunchAdForm((f) => ({ ...f, imageUrl: e.target.value }))} placeholder="https://…" className={inputCls} /></FormField></div>
                      <div className="col-span-2"><FormField label="Ad Copy (Message)"><textarea value={launchAdForm.message} onChange={(e) => setLaunchAdForm((f) => ({ ...f, message: e.target.value }))} placeholder="Write your ad copy here…" rows={2} className={`${inputCls} resize-none`} /></FormField></div>
                      <div><FormField label="Headline"><input type="text" value={launchAdForm.headline} onChange={(e) => setLaunchAdForm((f) => ({ ...f, headline: e.target.value }))} placeholder="Grab attention here" className={inputCls} /></FormField></div>
                      <div><FormField label="Destination URL"><input type="url" value={launchAdForm.linkUrl} onChange={(e) => setLaunchAdForm((f) => ({ ...f, linkUrl: e.target.value }))} placeholder="https://yourdomain.com/offer" className={inputCls} /></FormField></div>
                      <div className="col-span-2"><FormField label="Facebook Page ID" required hint="Your page ID from Business Manager → Pages"><input type="text" value={launchAdForm.pageId} onChange={(e) => setLaunchAdForm((f) => ({ ...f, pageId: e.target.value }))} placeholder="123456789012345" className={inputCls} /></FormField></div>
                      <div className="col-span-2 flex items-center justify-end gap-2 pt-2 border-t" style={{ borderColor: 'var(--border-subtle)' }}><button onClick={() => { setShowLaunchAd(false); setLaunchAdForm(defaultLaunchAdForm); }} className="px-4 py-2 rounded text-[11px] font-medium transition-all" style={{ background: 'var(--bg-elevated)', color: 'var(--text-secondary)', border: '1px solid var(--border-default)' }}>Cancel</button><button onClick={handleLaunchAd} disabled={launchAdSubmitting || !launchAdForm.adSetId || !launchAdForm.imageUrl || !launchAdForm.pageId} className="flex items-center gap-2 px-5 py-2 rounded text-[11px] font-semibold transition-all disabled:opacity-50" style={{ background: '#ffaa00', color: '#0a0a0f', border: '1px solid #ffaa00' }}>{launchAdSubmitting ? <><Spinner size={12} /> Launching…</> : <><IconBolt /> Launch Ad</>}</button></div>
                    </div>
                  )}
                </div>
              )}
              <div className="flex-1 px-6 py-4">
                {meta.loadingCampaigns && meta.campaigns.length === 0 ? (<div className="flex flex-col gap-2">{[1, 2, 3].map((i) => (<div key={i} className="h-14 rounded-lg animate-pulse" style={{ background: 'var(--bg-secondary)', border: '1px solid var(--border-subtle)' }} />))}</div>) : meta.campaigns.length === 0 ? (
                  <div className="flex flex-col items-center justify-center py-20 text-center"><svg width="40" height="40" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="0.8" className="text-af-border-default mb-4"><rect x="1" y="1" width="14" height="14" rx="2" /><path d="M5 8h6M8 5v6" strokeLinecap="round" /></svg><p className="text-[13px] font-semibold text-af-text-tertiary mb-1">No campaigns yet</p><p className="text-[11px] text-af-text-tertiary/50 max-w-[280px] leading-relaxed">Create your first campaign to start running Meta ads from AdForge.</p><button onClick={() => setShowCampaignForm(true)} className="mt-4 flex items-center gap-2 px-4 py-2 rounded text-[11px] font-semibold transition-all" style={{ background: 'var(--accent)', color: '#fff', border: '1px solid var(--accent)' }}><IconPlus /> Create Campaign</button></div>
                ) : (
                  <div className="flex flex-col gap-0 rounded-xl overflow-hidden border" style={{ borderColor: 'var(--border-subtle)' }}>
                    <div className="grid items-center px-4 py-2.5 text-[10px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em]" style={{ gridTemplateColumns: '1fr 120px 120px 100px 80px 90px 80px', background: 'var(--bg-secondary)', borderBottom: '1px solid var(--border-subtle)' }}><span>Campaign</span><span>Objective</span><span>Status</span><span>Budget</span><span>Spend</span><span>Created</span><span className="text-right">Actions</span></div>
                    {meta.campaigns.map((campaign, idx) => { const isExpanded = expandedCampaigns.has(campaign.id); const campaignAdSets = meta.adSets.filter((as) => as.campaign_id === campaign.id); return (<div key={campaign.id}><div className="group transition-colors" style={{ background: idx % 2 === 0 ? 'var(--bg-secondary)' : 'var(--bg-tertiary)', borderBottom: isExpanded ? '1px solid var(--border-subtle)' : (idx < meta.campaigns.length - 1 ? '1px solid var(--border-subtle)' : 'none') }}><div className="grid items-center px-4 py-3 hover:bg-af-bg-hover transition-colors cursor-pointer" style={{ gridTemplateColumns: '1fr 120px 120px 100px 80px 90px 80px' }}><div className="flex items-center gap-2 min-w-0" onClick={() => toggleCampaign(campaign.id)}><span className="text-af-text-tertiary flex-shrink-0 transition-transform"><IconChevron open={isExpanded} size={11} /></span><span className="text-[12px] font-medium text-af-text-primary truncate">{campaign.name}</span></div><span className="text-[10px] font-medium px-2 py-0.5 rounded w-fit" style={{ background: 'var(--bg-elevated)', color: 'var(--text-secondary)', border: '1px solid var(--border-default)' }}>{objectiveLabel(campaign.objective)}</span><StatusPill status={campaign.effective_status} /><span className="text-[11px] text-af-text-secondary tabular-nums">{fmtBudget(campaign)}</span><span className="text-[11px] text-af-text-tertiary tabular-nums">—</span><span className="text-[10px] text-af-text-tertiary">{fmtDate(campaign.created_time)}</span><div className="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">{campaign.effective_status !== 'ACTIVE' ? (<button onClick={() => handleCampaignAction(campaign.id, 'play')} title="Resume campaign" className="w-6 h-6 flex items-center justify-center rounded transition-all hover:bg-[rgba(0,204,102,0.15)]" style={{ color: '#00cc66' }}><IconPlay /></button>) : (<button onClick={() => handleCampaignAction(campaign.id, 'pause')} title="Pause campaign" className="w-6 h-6 flex items-center justify-center rounded transition-all hover:bg-[rgba(255,170,0,0.15)]" style={{ color: '#ffaa00' }}><IconPause /></button>)}<button onClick={() => handleCampaignAction(campaign.id, 'delete')} title="Delete campaign" className="w-6 h-6 flex items-center justify-center rounded transition-all hover:bg-[rgba(255,51,85,0.15)]" style={{ color: 'var(--text-tertiary)' }}><IconTrash /></button></div></div></div>{isExpanded && (<div style={{ background: 'var(--bg-primary)', borderBottom: '1px solid var(--border-subtle)' }}>{campaignAdSets.length === 0 ? (<div className="pl-12 pr-4 py-3 text-[11px] text-af-text-tertiary/50">No ad sets found for this campaign.</div>) : (campaignAdSets.map((adSet) => { const isAdSetExpanded = expandedAdSets.has(adSet.id); const adSetAds = meta.ads.filter((a) => a.adset_id === adSet.id); return (<div key={adSet.id}><div className="group flex items-center gap-2 pl-10 pr-4 py-2.5 hover:bg-af-bg-hover transition-colors cursor-pointer border-b" style={{ borderColor: 'var(--border-subtle)' }} onClick={() => toggleAdSet(adSet.id)}><span className="text-af-text-tertiary flex-shrink-0"><IconChevron open={isAdSetExpanded} size={10} /></span><div className="w-1.5 h-1.5 rounded-full flex-shrink-0" style={{ background: 'var(--accent)' }} /><span className="text-[11px] font-medium text-af-text-secondary flex-1 truncate">{adSet.name}</span><StatusPill status={adSet.effective_status} /><span className="text-[10px] text-af-text-tertiary ml-2">{adSet.daily_budget ? `${fmtMoney(parseInt(adSet.daily_budget, 10))}/day` : adSet.lifetime_budget ? `${fmtMoney(parseInt(adSet.lifetime_budget, 10))} lifetime` : '—'}</span><div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ml-2">{adSet.effective_status !== 'ACTIVE' ? (<button onClick={(e) => { e.stopPropagation(); meta.updateAdSetStatus(adSet.id, 'ACTIVE'); }} className="w-5 h-5 flex items-center justify-center rounded hover:bg-[rgba(0,204,102,0.15)] transition-all" style={{ color: '#00cc66' }} title="Resume ad set"><IconPlay /></button>) : (<button onClick={(e) => { e.stopPropagation(); meta.updateAdSetStatus(adSet.id, 'PAUSED'); }} className="w-5 h-5 flex items-center justify-center rounded hover:bg-[rgba(255,170,0,0.15)] transition-all" style={{ color: '#ffaa00' }} title="Pause ad set"><IconPause /></button>)}</div></div>{isAdSetExpanded && (<div style={{ background: 'rgba(0,0,0,0.15)' }}>{adSetAds.length === 0 ? (<div className="pl-16 pr-4 py-2.5 text-[10px] text-af-text-tertiary/40">No ads in this ad set.</div>) : (adSetAds.map((ad) => (<div key={ad.id} className="group flex items-center gap-2 pl-16 pr-4 py-2 border-b" style={{ borderColor: 'var(--border-subtle)' }}><div className="w-1 h-1 rounded-full flex-shrink-0" style={{ background: 'var(--text-tertiary)' }} /><span className="text-[10px] text-af-text-secondary flex-1 truncate">{ad.name}</span><StatusPill status={ad.effective_status} /><span className="text-[10px] font-mono text-af-text-tertiary/40">{ad.id.slice(-8)}</span><div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ml-1">{ad.effective_status !== 'ACTIVE' ? (<button onClick={() => meta.updateAdStatus(ad.id, 'ACTIVE')} className="w-5 h-5 flex items-center justify-center rounded hover:bg-[rgba(0,204,102,0.15)] transition-all" style={{ color: '#00cc66' }} title="Resume ad"><IconPlay /></button>) : (<button onClick={() => meta.updateAdStatus(ad.id, 'PAUSED')} className="w-5 h-5 flex items-center justify-center rounded hover:bg-[rgba(255,170,0,0.15)] transition-all" style={{ color: '#ffaa00' }} title="Pause ad"><IconPause /></button>)}<button onClick={() => setConfirmDelete({ type: 'ad', id: ad.id, name: ad.name })} className="w-5 h-5 flex items-center justify-center rounded hover:bg-[rgba(255,51,85,0.15)] transition-all" style={{ color: 'var(--text-tertiary)' }} title="Delete ad"><IconTrash /></button></div></div>)))}</div>)}</div>); }))}</div>)}</div>); })}
                  </div>
                )}
              </div>
            </div>
          )}

          {view === 'analytics' && (
            <div className="flex flex-col gap-0">
              <div className="flex-shrink-0 flex items-center justify-between gap-4 px-6 py-3.5 border-b" style={{ borderColor: 'var(--border-subtle)', background: 'var(--bg-secondary)' }}>
                <div className="flex items-center gap-1.5 flex-wrap"><span className="flex items-center gap-1 text-[10px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em] mr-1"><IconCalendar /> Period</span>{([{ value: 'today' as InsightsDatePreset, label: 'Today' }, { value: 'yesterday' as InsightsDatePreset, label: 'Yesterday' }, { value: 'last_3d' as InsightsDatePreset, label: '3 Days' }, { value: 'last_7d' as InsightsDatePreset, label: '7 Days' }, { value: 'last_14d' as InsightsDatePreset, label: '14 Days' }, { value: 'last_30d' as InsightsDatePreset, label: '30 Days' }, { value: 'this_month' as InsightsDatePreset, label: 'This Month' }, { value: 'last_month' as InsightsDatePreset, label: 'Last Month' }] as { value: InsightsDatePreset; label: string }[]).map((opt) => (<button key={opt.value} onClick={() => handleDatePresetChange(opt.value)} className="px-3 py-1 rounded text-[11px] font-medium transition-all" style={analyticsDatePreset === opt.value ? { background: 'rgba(0,102,255,0.12)', color: '#3399ff', border: '1px solid rgba(0,102,255,0.25)' } : { color: 'var(--text-tertiary)', border: '1px solid transparent' }}>{opt.label}</button>))}</div>
                <div className="flex items-center gap-3 flex-shrink-0">{lastRefreshed && (<span className="text-[10px] text-af-text-tertiary/60">Updated {minutesSince === 0 ? 'just now' : `${minutesSince}m ago`}</span>)}<button onClick={handleRefreshAnalytics} disabled={meta.loadingMetrics} className="flex items-center gap-1.5 px-3 py-1.5 rounded text-[11px] font-medium transition-all" style={{ background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', border: '1px solid var(--border-default)' }}><IconRefresh spinning={meta.loadingMetrics} />Refresh</button></div>
              </div>
              <div className="px-6 py-5 flex flex-col gap-6">
                {meta.loadingMetrics && !meta.metrics ? (<div className="grid grid-cols-4 gap-3">{Array.from({ length: 8 }).map((_, i) => (<div key={i} className="h-20 rounded-lg animate-pulse" style={{ background: 'var(--bg-secondary)', border: '1px solid var(--border-subtle)' }} />))}</div>) : meta.metrics ? (
                  <div className="grid grid-cols-4 gap-3">
                    <MetricCard label="Total Spend" value={fmtMoneyDollars(meta.metrics.totalSpend)} loading={meta.loadingMetrics} highlight />
                    <MetricCard label="Impressions" value={fmtNum(meta.metrics.totalImpressions)} loading={meta.loadingMetrics} />
                    <MetricCard label="Clicks" value={fmtNum(meta.metrics.totalClicks)} loading={meta.loadingMetrics} />
                    <MetricCard label="CTR" value={fmtPct(meta.metrics.ctr)} loading={meta.loadingMetrics} />
                    <MetricCard label="CPC" value={`$${meta.metrics.cpc.toFixed(2)}`} loading={meta.loadingMetrics} />
                    <MetricCard label="ROAS" value={meta.metrics.roas.toFixed(2)} loading={meta.loadingMetrics} />
                    <MetricCard label="Purchases" value={fmtNum(meta.metrics.purchases)} loading={meta.loadingMetrics} />
                    <MetricCard label="Cost / Purchase" value={meta.metrics.costPerPurchase > 0 ? fmtMoneyDollars(meta.metrics.costPerPurchase) : '—'} loading={meta.loadingMetrics} />
                  </div>
                ) : (<div className="flex items-center justify-center gap-3 p-6 rounded-xl text-center" style={{ background: 'var(--bg-secondary)', border: '1px solid var(--border-subtle)' }}><div className="flex flex-col items-center gap-2"><div className="text-af-text-tertiary"><IconInfo /></div><p className="text-[12px] text-af-text-tertiary">No metrics data yet.</p><button onClick={handleRefreshAnalytics} className="text-[11px] font-medium transition-all" style={{ color: '#3399ff' }}>Load metrics →</button></div></div>)}
                {meta.metrics && meta.metrics.dailyData.length > 0 && (<div className="rounded-xl overflow-hidden" style={{ border: '1px solid var(--border-subtle)' }}><div className="flex items-center justify-between px-5 py-3.5 border-b" style={{ background: 'var(--bg-secondary)', borderColor: 'var(--border-subtle)' }}><span className="text-[12px] font-semibold text-af-text-primary">Daily Performance</span><div className="flex items-center gap-1 rounded-lg overflow-hidden border" style={{ borderColor: 'var(--border-default)' }}><button onClick={() => setChartMetric('spend')} className="px-3 py-1 text-[10px] font-semibold transition-all" style={chartMetric === 'spend' ? { background: 'rgba(0,102,255,0.12)', color: '#3399ff' } : { background: 'var(--bg-elevated)', color: 'var(--text-tertiary)' }}>Spend</button><button onClick={() => setChartMetric('ctr')} className="px-3 py-1 text-[10px] font-semibold transition-all border-l" style={chartMetric === 'ctr' ? { background: 'rgba(0,204,102,0.12)', color: '#00cc66', borderColor: 'var(--border-default)' } : { background: 'var(--bg-elevated)', color: 'var(--text-tertiary)', borderColor: 'var(--border-default)' }}>CTR</button></div></div><div className="px-5 pt-5 pb-4" style={{ background: 'var(--bg-tertiary)', height: 180 }}><BarChart data={meta.metrics.dailyData} metric={chartMetric} /></div></div>)}
                {meta.metrics && meta.metrics.campaignBreakdown.length > 0 && (<div className="rounded-xl overflow-hidden" style={{ border: '1px solid var(--border-subtle)' }}><div className="flex items-center justify-between px-5 py-3.5 border-b" style={{ background: 'var(--bg-secondary)', borderColor: 'var(--border-subtle)' }}><span className="text-[12px] font-semibold text-af-text-primary">Campaign Breakdown</span></div><div className="grid items-center px-5 py-2.5 text-[10px] font-semibold text-af-text-tertiary uppercase tracking-[0.06em]" style={{ gridTemplateColumns: '1fr 100px 110px 90px 80px 80px', background: 'var(--bg-secondary)', borderBottom: '1px solid var(--border-subtle)' }}><span>Campaign</span>{([{ key: 'spend' as const, label: 'Spend' }, { key: 'impressions' as const, label: 'Impressions' }, { key: 'clicks' as const, label: 'Clicks' }, { key: 'ctr' as const, label: 'CTR' }, { key: 'roas' as const, label: 'ROAS' }]).map((col) => (<button key={col.key} onClick={() => handleSort(col.key)} className="flex items-center gap-1 text-left text-[10px] font-semibold uppercase tracking-[0.06em] transition-all" style={{ color: sortColumn === col.key ? '#3399ff' : 'var(--text-tertiary)' }}>{col.label}{sortColumn === col.key ? (sortDir === 'desc' ? <IconSortDesc /> : <IconSortAsc />) : <span className="opacity-30"><IconSortDesc /></span>}</button>))}</div>{sortedBreakdown.map((row, idx) => (<div key={row.campaign_id} className="grid items-center px-5 py-3 hover:bg-af-bg-hover transition-colors" style={{ gridTemplateColumns: '1fr 100px 110px 90px 80px 80px', background: idx % 2 === 0 ? 'var(--bg-secondary)' : 'var(--bg-tertiary)', borderTop: '1px solid var(--border-subtle)' }}><span className="text-[12px] font-medium text-af-text-primary truncate pr-4">{row.campaign_name}</span><span className="text-[11px] tabular-nums text-af-text-secondary">{fmtMoneyDollars(row.spend)}</span><span className="text-[11px] tabular-nums text-af-text-secondary">{fmtNum(row.impressions)}</span><span className="text-[11px] tabular-nums text-af-text-secondary">{fmtNum(row.clicks)}</span><span className="text-[11px] tabular-nums text-af-text-secondary">{fmtPct(row.ctr)}</span><span className="text-[11px] tabular-nums font-semibold" style={{ color: row.roas >= 2 ? '#00cc66' : row.roas >= 1 ? '#ffaa00' : 'var(--text-secondary)' }}>{row.roas.toFixed(2)}x</span></div>))}</div>)}
                {!meta.metrics && !meta.loadingMetrics && (<div className="flex flex-col items-center justify-center py-16 rounded-xl text-center" style={{ border: '1px solid var(--border-subtle)' }}><svg width="36" height="36" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="0.8" className="text-af-border-default mb-3"><rect x="1" y="8" width="3" height="7" rx="1" /><rect x="6" y="5" width="3" height="10" rx="1" /><rect x="11" y="2" width="3" height="13" rx="1" /></svg><p className="text-[13px] font-semibold text-af-text-tertiary mb-1">No analytics data</p><p className="text-[11px] text-af-text-tertiary/50 max-w-[260px] leading-relaxed mb-4">Connect your Meta account and run campaigns to see performance data.</p><button onClick={handleRefreshAnalytics} className="flex items-center gap-1.5 px-4 py-2 rounded text-[11px] font-medium transition-all" style={{ background: 'var(--bg-secondary)', color: '#3399ff', border: '1px solid rgba(0,102,255,0.2)' }}><IconRefresh /> Load Analytics</button></div>)}
              </div>
            </div>
          )}
        </div>
      </div>
      {confirmDelete && (<div className="fixed inset-0 z-50 flex items-center justify-center" style={{ background: 'rgba(0,0,0,0.7)', backdropFilter: 'blur(4px)' }} onClick={() => setConfirmDelete(null)}><div className="rounded-xl p-6 max-w-sm w-full mx-4" style={{ background: 'var(--bg-elevated)', border: '1px solid var(--border-default)' }} onClick={(e) => e.stopPropagation()}><div className="flex items-start gap-3 mb-5"><div className="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" style={{ background: 'rgba(255,51,85,0.15)', color: '#ff3355' }}><IconTrash /></div><div><p className="text-[13px] font-semibold text-af-text-primary">Delete {confirmDelete.type === 'campaign' ? 'Campaign' : 'Ad'}?</p><p className="text-[11px] text-af-text-secondary mt-1 leading-relaxed"><strong className="text-af-text-primary">"{confirmDelete.name}"</strong> will be permanently deleted. This action cannot be undone.</p></div></div><div className="flex items-center justify-end gap-2"><button onClick={() => setConfirmDelete(null)} className="px-4 py-2 rounded text-[11px] font-medium transition-all" style={{ background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', border: '1px solid var(--border-default)' }}>Cancel</button><button onClick={handleConfirmDelete} className="flex items-center gap-2 px-4 py-2 rounded text-[11px] font-semibold transition-all" style={{ background: '#ff3355', color: '#fff', border: '1px solid #ff3355' }}><IconTrash /> Delete</button></div></div></div>)}
    </>
  );
}
